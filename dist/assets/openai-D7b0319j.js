const w={name:"flashcards_response",strict:!0,schema:{type:"object",properties:{cards:{type:"array",description:"A list of flashcards generated from the text.",items:{type:"object",properties:{type:{type:"string",enum:["basic","cloze"],description:"The type of flashcard: 'basic' for Q&A, 'cloze' for fill-in-the-blank."},front:{type:"string",description:"The question or front side of the card (for basic type)."},back:{type:"string",description:"The answer (for basic type). For cloze type, this is the Extra Info/Context (optional, max 30 words)."},text:{type:"string",description:"The cloze text with {{c1::hidden}} parts (only for cloze type)."},tags:{type:"array",items:{type:"string"},description:"Tags for categorizing the card."}},required:["type","front","back","text","tags"],additionalProperties:!1}}},required:["cards"],additionalProperties:!1}},O=n=>new Promise(l=>setTimeout(l,n));async function T(n,l,u,c,g=null,o=!1,p=2,d=null){let i=g||"https://api.openai.com/v1";i=i.replace(/\/+$/,""),i.endsWith("/chat/completions")||(i+="/chat/completions");const f=i;for(let s=0;s<=p;s++)try{console.log(`[OpenAI] Attempt ${s+1}: POST ${f} (Model: ${n}, Schema: ${o})`);const t={model:n,messages:[{role:"system",content:o?"You are a helpful assistant. Output must strictly follow the provided JSON schema.":"You are a helpful assistant designed to output JSON."},{role:"user",content:[{type:"text",text:u},{type:"image_url",image_url:{url:c.startsWith("data:")?c:`data:image/png;base64,${c}`,detail:"high"}}]}]};o?t.response_format={type:"json_schema",json_schema:d||w}:t.response_format={type:"json_object"};const a=await fetch(f,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify(t)}),r=await a.json();if(console.log("[OpenAI] Raw Response:",r),r.error){const y=typeof r.error=="string"?r.error:r.error.message;throw new Error(`OpenAI API Error: ${y}`)}if(!a.ok)throw new Error(`HTTP Error: ${a.status} ${a.statusText}`);if(!r.choices||!r.choices.length)throw new Error("Invalid response structure: 'choices' array is missing or empty.");const h=r.choices[0].message.content,e=JSON.parse(h);if(o){const y=e;return e.cards&&Array.isArray(e.cards)?e.cards:Array.isArray(e)?e:[]}else{if(!Array.isArray(e)&&typeof e=="object"){const m=Object.values(e).find(A=>Array.isArray(A));if(m)return m}return Array.isArray(e)?e:[]}}catch(t){if(console.warn(`[OpenAI] Error with model ${n} on attempt ${s+1}:`,t),!(!t.status||t.status===429||t.status===503||t.status>=500)||s===p)throw t;await O(1e3*Math.pow(2,s))}}async function $(n,l,u,c,g,o=null,p="",d=!1,i=[],f=1,s=null){if(!l&&!o)throw new Error("API Key is required for OpenAI.");const a=(g||"You are an expert Flashcard Creator...").replace("{{textContent}}",u||"").replace("{{existingContext}}",c||"None");console.log("--- OPENAI PROMPT START ---"),console.log(`Model: ${p}, BaseURL: ${o||"Default"}, useSchema: ${d}, Retries: ${f}`),console.log(a),console.log("--- OPENAI PROMPT END ---");const r=[p,...i];let h=null;for(const e of r)try{return await T(e,l,a,n,o,d,f,s)}catch(y){console.error(`Failed with model ${e}. Falling back...`),h=y}throw console.error("All OpenAI models failed."),h||new Error("All OpenAI models failed to generate content.")}export{$ as generateCardsOpenAI};
